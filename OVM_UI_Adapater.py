"""Subclass of OVM_Frame, which is generated by wxFormBuilder."""

import wx
import OVM_UI
from CustomUI.VideoPanel import VideoPanel
from OVM_IPCamera import Camera


DEBUG = True
# Implementing OVM_Frame
class OVM_UI_Adapater( OVM_UI.OVM_Frame ):
	def __init__( self, parent ):
		OVM_UI.OVM_Frame.__init__( self, parent )

		# Set starting configuration
		self.panel_mainsettings.Hide()
		self.panel_mainvideo.Show()
		self.Video_NumFeeds_Sldr.SetValue(4)
		self.Video_CycleCams_chkBox.SetValue(False)
		self.Video_AvailCams_chkLst.Clear()

		# Data store Model for Video Panels
		self.video_panels = []
		self.video_panels.append(self.Video_videoPanel_0)
		self.video_panels.append(self.Video_videoPanel_1)
		self.video_panels.append(self.Video_videoPanel_11)
		self.video_panels.append(self.Video_videoPanel_12)

		# Data store Model for Cameras
		self.camera_list = []
		self.enabled_camera_list = []

		# Data store model for Application settings
		self.settings_model = None
			#TODO: Sprint 3 Tickets #25 and #26 to save and load settings functionality

		# Populate a debug list of cameras
		if(DEBUG):
			self.debug_populate_cameras()

		self.Show()


	########### Event Handler implementation ###########
	def Handle_MenuItem_Video( self, event ):
		self.panel_mainsettings.Hide()
		self.panel_mainvideo.Show()

		self.Layout()
		self.Refresh()
		return

	def Handle_MenuItem_Settings( self, event ):
		self.panel_mainsettings.Show()
		self.panel_mainvideo.Hide()

		self.Layout()
		self.Refresh()
		return

	def Handle_MenuItem_Exit( self, event ):
		self.update_video_panels(0)
		self.Close(True)
		return
	
	def Handle_Video_EnDisCycle( self, event ):
		self.todo_feature_test()
		event.Skip()

	def Handle_Video_NumFeeds( self, event ):
		num_videos = self.Video_NumFeeds_Sldr.GetValue()

		# Only update if the number changed from whats currently displayed
		if(len(self.video_panels) != num_videos):
			self.update_video_panels(num_videos)
		event.Skip()

	def Handle_CameraChkLst_Toggle( self, event ):
		# Get the name and state changed camera
		cam_name = self.Video_AvailCams_chkLst.GetString(event.GetInt())
		cam_state = self.Video_AvailCams_chkLst.IsChecked(event.GetInt())
		print(f"Camera {cam_name} was set to {cam_state}")
		# Find the camera in the list and update its state
		for camera in self.camera_list:
			if camera.get_Name() == cam_name:
				camera.set_Enable(cam_state)

		# Refresh the cameras
		self.update_video_panels(self.Video_NumFeeds_Sldr.GetValue())

		# self.todo_feature_test("Camera: " + str(event.GetInt()) + " " + cam_name)
		event.Skip()

	def Handle_Setting_NewCameraBtn( self, event ):
		name = self.Settings_CamName_txtCtrl.GetValue()
		addr = self.Settings_CamAddr_txtCtrl.GetValue()
		print("Attempt to add camera: " + name + " At Address: " + addr)
		camera = Camera(name, addr)
		self.camera_list.append(camera)

		self.update_CameraLists()

		self.Layout()
		self.Refresh()
		event.Skip()

	def Handle_Setting_RemoveCameraBtn( self, event ):
		self.Settings_CamList_chkLst.GetCheckedStrings()
		self.todo_feature_test()
		event.Skip()

	def Handle_Setting_EnDisSaving( self, event ):
		self.todo_feature_test()
		event.Skip()

	def Handle_Setting_SaveLocation( self, event ):
		self.todo_feature_test()
		event.Skip()

	########### End Event Handler Implementation ###########

	def update_video_panels(self, num_feeds):
		#Stop and remove existing panels if reducing the number
		while len(self.video_panels) > num_feeds:
			videoPanel = self.video_panels.pop()
			
			videoPanel.stop_stream()
			videoPanel.Destroy()

		# Create new panels if increasing the number, Add to tracking list, add to the sizer
		while len(self.video_panels) < num_feeds:
			videoPanel = VideoPanel(self.panel_mainvideo, 0)
			self.video_panels.append(videoPanel)
			self.gridsizer_videofeeds.Add(videoPanel,1,wx.EXPAND)

		# Get a list of enabled cameras
		enabled_cameras = self.get_Enabled_Cameras()

		# Set sources and Restart Streams on the panels
		for panel_num, selectedPanel in enumerate(self.video_panels):
			if(len(enabled_cameras) > panel_num):
				camera_feed = enabled_cameras[panel_num].get_Address()
				if camera_feed == "localhost":
					camera_feed = 0
			else:
				break
			print("Setting source of panel: " + str(panel_num) + " to: " + str(camera_feed))
			selectedPanel.set_source(camera_feed)
			selectedPanel.start_stream()

		#Update layout and refresh
		if(num_feeds == 1):
			self.gridsizer_videofeeds.SetCols(1)
		else:
			self.gridsizer_videofeeds.SetCols(2)
		
		self.gridsizer_videofeeds.Layout()
		self.Layout()

	def get_Enabled_Cameras(self):
		enabled_cameras = []
		for camera in self.camera_list:
			if camera.is_Enabled():
				enabled_cameras.append(camera)
		return enabled_cameras
	
	def update_CameraLists(self):
		#clean out the Video Feed panel  and setting panel lists
		self.Video_AvailCams_chkLst.Clear()
		self.Settings_CamList_chkLst.Clear()

		#Repopulate both
		for camera in self.camera_list:
			index = self.Video_AvailCams_chkLst.Append(camera.get_Name())
			if camera.is_Enabled():
				self.Video_AvailCams_chkLst.Check(index)
			self.Settings_CamList_chkLst.Append(camera.get_Name())

		return
	
	def todo_feature_test(self, string = "Todo Feature"):
		wx.MessageBox(string)
		return
	
	def debug_populate_cameras(self):
		"rtsp://ekbc:7478sm@mobileb-smith.hopto.org/channel=1"
		"rtsp://raf:rafraf@mobilebsmith.hopto.org/main_1"
		"192.168.43.100"
		"rtsp://raf:rafraf@142.196.231.255?stream=1.sdp" "rtsp://raf:rafraf@142.196.231.255?stream=2.sdp"
		"rtsp://142.196.231.255:554/user=raf&password=rafraf&channel=1&stream=1.sdp"
		"rtsp://192.168.43.100:554/user=raf&password=rafraf&channel=1&stream=1.sdp"
		"rtsp://raf:rafraf@mobilebsmith.hopto.org/channel=1?stream=1.sdp"
		address_list = [
				"rtsp://raf:rafraf@mobilebsmith.hopto.org/channel=1?stream=1.sdp",
				"rtsp://raf:rafraf@mobilebsmith.hopto.org/channel=2?stream=1.sdp",
				"rtsp://raf:rafraf@mobilebsmith.hopto.org/channel=3?stream=1.sdp",
				"rtsp://raf:rafraf@mobilebsmith.hopto.org/channel=4?stream=1.sdp"
				]
		# address_list = ["rtsp://142.196.231.255:554/user=raf&password=rafraf&channel=1&stream=1.sdp","rtsp://142.196.231.255:554/user=raf&password=rafraf&channel=2&stream=1.sdp", "rtsp://142.196.231.255:554/user=raf&password=rafraf&channel=3&stream=1.sdp","rtsp://142.196.231.255:554/user=raf&password=rafraf&channel=4&stream=1.sdp"]
		for num, address in  enumerate(address_list):
			name = "Debug Camera " + str(num)
			camera = Camera(name, address)
			camera.enable()
			print("Added " + camera.to_String())
			self.camera_list.append(camera)
			self.update_CameraLists()
		
		self.update_video_panels(len(address_list))
			
